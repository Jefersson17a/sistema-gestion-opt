<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n OPT - Incidencias y Desarrollos</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ°Ô∏è</text></svg>">
    <meta name="description" content="Sistema de Gesti√≥n de Incidencias y Desarrollos para OPT">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --gray: #6b7280;
            --light: #f3f4f6;
            --white: #ffffff;
            --purple: #8b5cf6;
            --purple-light: #a78bfa;
            --slack: #4A154B;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--light);
        }

        .header h1 {
            color: var(--dark);
            font-size: 2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header .stats {
            display: flex;
            gap: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: var(--white);
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .user-info .user-badge {
            background: var(--primary);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .stat-card {
            background: var(--white);
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-card .label {
            color: var(--gray);
            font-size: 0.9em;
            margin-top: 5px;
        }

        .config-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--slack);
            color: white;
            padding: 15px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s;
            z-index: 999;
        }

        .config-button:hover {
            transform: scale(1.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }

        .modal-close {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
        }

        .auth-form {
            margin-top: 20px;
        }

        .auth-form input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 2px solid var(--light);
            border-radius: 8px;
        }

        .auth-form button {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
        }

        .slack-config {
            background: var(--light);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .slack-config input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 2px solid var(--white);
            border-radius: 8px;
        }

        .slack-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
        }

        .slack-status.connected {
            background: #d1fae5;
            color: #065f46;
        }

        .slack-status.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--light);
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            position: relative;
            transition: all 0.3s;
        }

        .tab.active {
            color: var(--primary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            border-radius: 3px 3px 0 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-section {
            background: var(--white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid var(--light);
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .type-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .type-card {
            padding: 20px;
            border: 3px solid var(--light);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .type-card.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        }

        .type-card .icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .type-card .title {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .type-card .description {
            color: var(--gray);
            font-size: 0.9em;
        }

        .image-upload {
            border: 2px dashed var(--gray);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--light);
        }

        .image-upload:hover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }

        .image-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .image-preview-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: var(--light);
            aspect-ratio: 1;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.9;
        }

        .image-preview-item .remove-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .department-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 500;
            background: var(--purple-light);
            color: white;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-info {
            background: var(--purple);
            color: white;
        }

        .action-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .incidents-grid {
            display: grid;
            gap: 20px;
        }

        .incident-card {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            border-left: 4px solid var(--gray);
        }

        .incident-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .incident-card.critical {
            border-left-color: var(--danger);
        }

        .incident-card.high {
            border-left-color: var(--warning);
        }

        .incident-card.medium {
            border-left-color: var(--primary);
        }

        .incident-card.low {
            border-left-color: var(--success);
        }

        .incident-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .incident-id {
            font-weight: bold;
            color: var(--primary);
            font-size: 0.9em;
        }

        .incident-title {
            font-size: 1.2em;
            color: var(--dark);
            margin: 5px 0;
        }

        .incident-meta {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--gray);
            font-size: 0.9em;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .status-new {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-progress {
            background: #fef3c7;
            color: #92400e;
        }

        .status-resolved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-closed {
            background: #e5e7eb;
            color: #374151;
        }

        .status-pending {
            background: #f3e8ff;
            color: #6b21a8;
        }

        .status-approved {
            background: #dcfce7;
            color: #166534;
        }

        .status-in-progress {
            background: #fed7aa;
            color: #9a3412;
        }

        .status-testing {
            background: #bfdbfe;
            color: #1e3a8a;
        }

        .status-completed {
            background: #bbf7d0;
            color: #14532d;
        }

        .status-cancelled {
            background: #fecaca;
            color: #991b1b;
        }

        .status-info-needed {
            background: #e0e7ff;
            color: #3730a3;
        }

        .dev-card {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-left: 4px solid #8b5cf6;
        }

        .dev-card:hover {
            background: linear-gradient(135deg, #667eea25 0%, #764ba225 100%);
        }

        .type-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 500;
            background: #f3e8ff;
            color: #6b21a8;
        }

        .priority-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .priority-critical {
            background: #fee2e2;
            color: #991b1b;
        }

        .priority-high {
            background: #fed7aa;
            color: #9a3412;
        }

        .priority-medium {
            background: #dbeafe;
            color: #1e40af;
        }

        .priority-low {
            background: #d1fae5;
            color: #065f46;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .chart-card {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .chart-card h3 {
            color: var(--dark);
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: var(--light);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .filters-section {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--gray);
            font-size: 0.9em;
        }

        .filter-group select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid var(--light);
            border-radius: 8px;
            background: white;
        }

        .duplicate-warning {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            color: #92400e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .info-request {
            background: #e0e7ff;
            border: 2px solid #6366f1;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .info-request textarea {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border: 2px solid var(--light);
            border-radius: 8px;
            min-height: 80px;
        }

        .timeline {
            margin-top: 20px;
        }

        .timeline-item {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            position: relative;
        }

        .timeline-marker {
            width: 12px;
            height: 12px;
            background: var(--primary);
            border-radius: 50%;
            margin-top: 5px;
            position: relative;
        }

        .timeline-item:not(:last-child) .timeline-marker::after {
            content: '';
            position: absolute;
            top: 12px;
            left: 5px;
            width: 2px;
            height: 40px;
            background: var(--light);
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-date {
            color: var(--gray);
            font-size: 0.85em;
        }

        .timeline-text {
            color: var(--dark);
            margin-top: 5px;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .image-gallery img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .image-gallery img:hover {
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
            }

            .header .stats {
                width: 100%;
                justify-content: space-between;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .charts-container {
                grid-template-columns: 1fr;
            }

            .type-selector {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span>üõ°Ô∏è</span> Sistema de Gesti√≥n OPT
            </h1>
            <div style="display: flex; align-items: center; gap: 20px;">
                <div class="user-info">
                    <span>üë§ Usuario:</span>
                    <span id="currentUser">No autenticado</span>
                    <span id="userRole" class="user-badge" style="display: none;"></span>
                </div>
                <div class="stats">
                    <div class="stat-card">
                        <div class="value" id="totalIncidents">0</div>
                        <div class="label">Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="openIncidents">0</div>
                        <div class="label">Abiertas</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="resolvedIncidents">0</div>
                        <div class="label">Resueltas</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('newRequest')">‚ûï Nueva Solicitud</button>
            <button class="tab" onclick="switchTab('incidents')">üìã Incidencias</button>
            <button class="tab" onclick="switchTab('developments')">üí° Desarrollos</button>
            <button class="tab" onclick="switchTab('reports')">üìà Reportes</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="charts-container">
                <div class="chart-card">
                    <h3>Estado de Solicitudes</h3>
                    <canvas id="statusChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Prioridades</h3>
                    <canvas id="priorityChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Progreso Semanal</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="weeklyProgress" style="width: 0%">
                            0%
                        </div>
                    </div>
                    <p style="margin-top: 10px; color: var(--gray);">
                        <span id="resolvedThisWeek">0</span> de <span id="totalThisWeek">0</span> solicitudes resueltas esta semana
                    </p>
                </div>
                <div class="chart-card">
                    <h3>Tendencia Semanal</h3>
                    <canvas id="trendChart" width="400" height="200"></canvas>
                </div>
            </div>

            <h3 style="margin-top: 30px; margin-bottom: 20px; color: var(--dark);">Solicitudes Recientes</h3>
            <div id="recentIncidents" class="incidents-grid">
                <!-- Solicitudes recientes se cargar√°n aqu√≠ -->
            </div>
        </div>

        <!-- Nueva Solicitud Unificada Tab -->
        <div id="newRequest" class="tab-content">
            <form class="form-section" onsubmit="createRequest(event)">
                <h3 style="margin-bottom: 20px; color: var(--dark);">üìù Nueva Solicitud OPT</h3>
                
                <!-- Selector de Tipo -->
                <div class="form-group">
                    <label>Seleccione el tipo de solicitud *</label>
                    <div class="type-selector">
                        <div class="type-card" onclick="selectRequestType('incident')">
                            <div class="icon">üêõ</div>
                            <div class="title">Reportar Incidencia</div>
                            <div class="description">Errores, bugs, problemas del sistema</div>
                        </div>
                        <div class="type-card" onclick="selectRequestType('development')">
                            <div class="icon">üöÄ</div>
                            <div class="title">Solicitar Desarrollo</div>
                            <div class="description">Nuevas funcionalidades, mejoras</div>
                        </div>
                    </div>
                    <input type="hidden" id="requestType" required>
                </div>

                <div class="duplicate-warning" id="duplicateWarning">
                    ‚ö†Ô∏è <strong>Posible duplicado detectado:</strong> Ya existe una solicitud similar. Por favor, verifica antes de crear una nueva.
                </div>

                <!-- Campos comunes -->
                <div id="commonFields" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Departamento *</label>
                            <select id="department" required>
                                <option value="">Seleccionar...</option>
                                <option value="support-emea">Support EMEA</option>
                                <option value="support-amer">Support AMER</option>
                                <option value="support-apac">Support APAC</option>
                                <option value="sales">SALES</option>
                                <option value="qa">QA</option>
                                <option value="training">TRAINING</option>
                                <option value="other">OTRO</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Solicitado por *</label>
                            <input type="text" id="requester" required placeholder="Tu nombre">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>T√≠tulo *</label>
                        <input type="text" id="title" required placeholder="Descripci√≥n breve" oninput="checkDuplicates()">
                    </div>

                    <div class="form-group">
                        <label>Descripci√≥n Detallada *</label>
                        <textarea id="description" required placeholder="Describe detalladamente la solicitud"></textarea>
                    </div>

                    <!-- Campos espec√≠ficos de incidencia -->
                    <div id="incidentFields" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Prioridad *</label>
                                <select id="incidentPriority">
                                    <option value="">Seleccionar...</option>
                                    <option value="critical">Cr√≠tica - Sistema inoperativo</option>
                                    <option value="high">Alta - Funcionalidad mayor afectada</option>
                                    <option value="medium">Media - Funcionalidad menor afectada</option>
                                    <option value="low">Baja - Problema cosm√©tico</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Categor√≠a *</label>
                                <select id="incidentCategory">
                                    <option value="">Seleccionar...</option>
                                    <option value="bug">Error/Bug</option>
                                    <option value="performance">Rendimiento</option>
                                    <option value="security">Seguridad</option>
                                    <option value="ui">Interfaz de Usuario</option>
                                    <option value="data">Datos</option>
                                    <option value="integration">Integraci√≥n</option>
                                    <option value="other">Otro</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Pasos para Reproducir</label>
                            <textarea id="incidentSteps" placeholder="1. Paso uno&#10;2. Paso dos&#10;3. ..."></textarea>
                        </div>
                    </div>

                    <!-- Campos espec√≠ficos de desarrollo -->
                    <div id="developmentFields" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Tipo de Desarrollo *</label>
                                <select id="devType">
                                    <option value="">Seleccionar...</option>
                                    <option value="new-feature">Nueva Funcionalidad</option>
                                    <option value="improvement">Mejora de Funcionalidad Existente</option>
                                    <option value="integration">Integraci√≥n con Sistema Externo</option>
                                    <option value="report">Nuevo Reporte/Dashboard</option>
                                    <option value="automation">Automatizaci√≥n de Proceso</option>
                                    <option value="ui-change">Cambio de Interfaz</option>
                                    <option value="api">Desarrollo de API</option>
                                    <option value="migration">Migraci√≥n/Actualizaci√≥n</option>
                                    <option value="other">Otro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Impacto en el Negocio *</label>
                                <select id="devImpact">
                                    <option value="">Seleccionar...</option>
                                    <option value="critical">Cr√≠tico - Bloquea operaciones</option>
                                    <option value="high">Alto - Mejora significativa</option>
                                    <option value="medium">Medio - Optimizaci√≥n importante</option>
                                    <option value="low">Bajo - Nice to have</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Fecha Esperada de Entrega</label>
                                <input type="date" id="devExpectedDate">
                            </div>
                            <div class="form-group">
                                <label>Presupuesto Estimado</label>
                                <input type="text" id="devBudget" placeholder="Opcional">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Justificaci√≥n del Negocio</label>
                            <textarea id="devJustification" placeholder="¬øQu√© problema resuelve? ¬øQu√© beneficios aporta?"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Criterios de Aceptaci√≥n</label>
                            <textarea id="devAcceptance" placeholder="¬øQu√© debe cumplir para considerarse completo?"></textarea>
                        </div>
                    </div>

                    <!-- Carga de im√°genes -->
                    <div class="form-group">
                        <label>Adjuntar Im√°genes de Apoyo</label>
                        <div class="image-upload" onclick="document.getElementById('imageInput').click()">
                            <p>üì∑ Click aqu√≠ para seleccionar im√°genes</p>
                            <p style="font-size: 0.9em; color: var(--gray);">O arrastra y suelta las im√°genes aqu√≠</p>
                            <p style="font-size: 0.8em; color: var(--gray);">M√°ximo 5 im√°genes, 5MB cada una</p>
                        </div>
                        <input type="file" id="imageInput" accept="image/*" multiple style="display: none;" onchange="handleImageUpload(event)">
                        <div id="imagePreview" class="image-preview"></div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <span>üì§</span> Enviar Solicitud
                    </button>
                </div>
            </form>
        </div>

        <!-- Lista de Incidencias Tab -->
        <div id="incidents" class="tab-content">
            <div class="filters-section">
                <div class="filter-group">
                    <label>Estado</label>
                    <select id="filterStatus" onchange="filterIncidents()">
                        <option value="">Todos</option>
                        <option value="new">Nuevo</option>
                        <option value="progress">En Progreso</option>
                        <option value="info-needed">Info Requerida</option>
                        <option value="resolved">Resuelto</option>
                        <option value="closed">Cerrado</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Prioridad</label>
                    <select id="filterPriority" onchange="filterIncidents()">
                        <option value="">Todas</option>
                        <option value="critical">Cr√≠tica</option>
                        <option value="high">Alta</option>
                        <option value="medium">Media</option>
                        <option value="low">Baja</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Departamento</label>
                    <select id="filterDepartment" onchange="filterIncidents()">
                        <option value="">Todos</option>
                        <option value="support-emea">Support EMEA</option>
                        <option value="support-amer">Support AMER</option>
                        <option value="support-apac">Support APAC</option>
                        <option value="sales">SALES</option>
                        <option value="qa">QA</option>
                        <option value="training">TRAINING</option>
                        <option value="other">OTRO</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="filterIncidents()">
                    üîç Aplicar Filtros
                </button>
            </div>

            <div id="incidentsList" class="incidents-grid">
                <!-- Lista de incidencias se cargar√° aqu√≠ -->
            </div>
        </div>

        <!-- Lista de Desarrollos Tab -->
        <div id="developments" class="tab-content">
            <div class="filters-section">
                <div class="filter-group">
                    <label>Estado</label>
                    <select id="filterDevStatus" onchange="filterDevelopments()">
                        <option value="">Todos</option>
                        <option value="pending">Pendiente</option>
                        <option value="approved">Aprobado</option>
                        <option value="in-progress">En Desarrollo</option>
                        <option value="info-needed">Info Requerida</option>
                        <option value="testing">En Pruebas</option>
                        <option value="completed">Completado</option>
                        <option value="cancelled">Cancelado</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Tipo</label>
                    <select id="filterDevType" onchange="filterDevelopments()">
                        <option value="">Todos</option>
                        <option value="new-feature">Nueva Funcionalidad</option>
                        <option value="improvement">Mejora</option>
                        <option value="integration">Integraci√≥n</option>
                        <option value="report">Reporte</option>
                        <option value="automation">Automatizaci√≥n</option>
                        <option value="ui-change">Cambio UI</option>
                        <option value="api">API</option>
                        <option value="migration">Migraci√≥n</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Departamento</label>
                    <select id="filterDevDepartment" onchange="filterDevelopments()">
                        <option value="">Todos</option>
                        <option value="support-emea">Support EMEA</option>
                        <option value="support-amer">Support AMER</option>
                        <option value="support-apac">Support APAC</option>
                        <option value="sales">SALES</option>
                        <option value="qa">QA</option>
                        <option value="training">TRAINING</option>
                        <option value="other">OTRO</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="filterDevelopments()">
                    üîç Aplicar Filtros
                </button>
            </div>

            <div id="developmentsList" class="incidents-grid">
                <!-- Lista de desarrollos se cargar√° aqu√≠ -->
            </div>
        </div>

        <!-- Reportes Tab -->
        <div id="reports" class="tab-content">
            <div class="form-section">
                <h3 style="margin-bottom: 20px; color: var(--dark);">Generar Reporte</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Desde</label>
                        <input type="date" id="reportStartDate">
                    </div>
                    <div class="form-group">
                        <label>Hasta</label>
                        <input type="date" id="reportEndDate">
                    </div>
                    <div class="form-group">
                        <label>Departamento</label>
                        <select id="reportDepartment">
                            <option value="">Todos</option>
                            <option value="support-emea">Support EMEA</option>
                            <option value="support-amer">Support AMER</option>
                            <option value="support-apac">Support APAC</option>
                            <option value="sales">SALES</option>
                            <option value="qa">QA</option>
                            <option value="training">TRAINING</option>
                            <option value="other">OTRO</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="generateReport()">
                    üìä Generar Reporte
                </button>
                <button class="btn btn-success" onclick="exportReport()" style="margin-left: 10px;">
                    üíæ Exportar CSV
                </button>
            </div>

            <div id="reportContent" style="display: none;">
                <div class="form-section" style="margin-top: 20px;">
                    <h3 style="margin-bottom: 20px; color: var(--dark);">Resumen del Per√≠odo</h3>
                    <div id="reportSummary"></div>
                </div>

                <div class="form-section" style="margin-top: 20px;">
                    <h3 style="margin-bottom: 20px; color: var(--dark);">M√©tricas de Resoluci√≥n</h3>
                    <div id="reportMetrics"></div>
                </div>

                <div class="form-section" style="margin-top: 20px;">
                    <h3 style="margin-bottom: 20px; color: var(--dark);">Detalle de Solicitudes</h3>
                    <div id="reportDetails"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot√≥n de Configuraci√≥n -->
    <div class="config-button" onclick="openConfigModal()">
        ‚öôÔ∏è
    </div>

    <!-- Modal de Configuraci√≥n -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Configuraci√≥n del Sistema</h2>
                <button class="modal-close" onclick="closeConfigModal()">‚úï</button>
            </div>

            <!-- Autenticaci√≥n -->
            <div class="auth-form">
                <h3>üîê Autenticaci√≥n de Administrador</h3>
                <p style="color: var(--gray); font-size: 0.9em; margin-bottom: 15px;">
                    Solo usuarios autorizados pueden cambiar el estado de las solicitudes
                </p>
                <input type="text" id="authUsername" placeholder="Usuario">
                <input type="password" id="authPassword" placeholder="Contrase√±a">
                <button onclick="authenticate()">Iniciar Sesi√≥n</button>
                <div id="authMessage" style="margin-top: 10px; padding: 10px; border-radius: 5px; display: none;"></div>
            </div>

            <!-- Configuraci√≥n de Slack -->
            <div class="slack-config">
                <h3>üîî Configuraci√≥n de Slack</h3>
                <p style="color: var(--gray); font-size: 0.9em; margin-bottom: 15px;">
                    Las notificaciones se enviar√°n al canal configurado cuando se cambien estados o se requiera informaci√≥n
                </p>
                <label>Webhook URL de Slack:</label>
                <input type="text" id="slackWebhook" placeholder="https://hooks.slack.com/services/..." value="">
                <label>Canal de Slack:</label>
                <input type="text" id="slackChannel" placeholder="#opt-notifications" value="#opt-notifications">
                <button class="btn btn-primary" onclick="saveSlackConfig()" style="margin-top: 10px;">
                    üíæ Guardar Configuraci√≥n
                </button>
                <div class="slack-status disconnected" id="slackStatus">
                    <span>‚ö†Ô∏è</span> Slack no configurado
                </div>
            </div>

            <!-- Gesti√≥n de Usuarios Autorizados (solo para admins) -->
            <div id="userManagement" style="display: none; margin-top: 20px;">
                <h3>üë• Usuarios Autorizados</h3>
                <div id="authorizedUsersList"></div>
                <div style="margin-top: 15px;">
                    <input type="text" id="newUserName" placeholder="Nombre del nuevo usuario">
                    <button class="btn btn-success" onclick="addAuthorizedUser()">
                        ‚ûï Agregar Usuario
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n del sistema
        const CONFIG = {
            AUTHORIZED_USERS: [
                { username: 'admin', password: 'admin123', role: 'admin' },
                { username: 'manager', password: 'manager123', role: 'manager' },
                { username: 'developer', password: 'dev123', role: 'developer' }
            ],
            SLACK_CONFIG: JSON.parse(localStorage.getItem('slackConfig') || '{}')
        };

        // Base de datos local
        let incidents = JSON.parse(localStorage.getItem('incidents') || '[]');
        let developments = JSON.parse(localStorage.getItem('developments') || '[]');
        let currentIncidentId = parseInt(localStorage.getItem('lastIncidentId') || '1000');
        let currentDevId = parseInt(localStorage.getItem('lastDevId') || '2000');
        let uploadedImages = [];
        let currentUser = null;

        // Funci√≥n para guardar datos
        function saveData() {
            localStorage.setItem('incidents', JSON.stringify(incidents));
            localStorage.setItem('developments', JSON.stringify(developments));
            localStorage.setItem('lastIncidentId', currentIncidentId.toString());
            localStorage.setItem('lastDevId', currentDevId.toString());
        }

        // Funci√≥n de autenticaci√≥n
        function authenticate() {
            const username = document.getElementById('authUsername').value;
            const password = document.getElementById('authPassword').value;
            const messageEl = document.getElementById('authMessage');
            
            const user = CONFIG.AUTHORIZED_USERS.find(u => 
                u.username === username && u.password === password
            );
            
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                messageEl.style.display = 'block';
                messageEl.style.background = '#d1fae5';
                messageEl.style.color = '#065f46';
                messageEl.textContent = '‚úÖ Autenticaci√≥n exitosa';
                
                // Actualizar UI
                document.getElementById('currentUser').textContent = user.username;
                document.getElementById('userRole').textContent = user.role.toUpperCase();
                document.getElementById('userRole').style.display = 'inline';
                
                if (user.role === 'admin') {
                    document.getElementById('userManagement').style.display = 'block';
                    loadAuthorizedUsers();
                }
                
                setTimeout(() => {
                    closeConfigModal();
                }, 1500);
                
                // Recargar las listas para mostrar botones de acci√≥n
                updateDashboard();
                loadIncidentsList();
                loadDevelopmentsList();
            } else {
                messageEl.style.display = 'block';
                messageEl.style.background = '#fee2e2';
                messageEl.style.color = '#991b1b';
                messageEl.textContent = '‚ùå Credenciales incorrectas';
            }
        }

        // Verificar si el usuario puede modificar estados
        function canModifyStatus() {
            return currentUser !== null;
        }

        // Configuraci√≥n de Slack
        function saveSlackConfig() {
            const webhook = document.getElementById('slackWebhook').value;
            const channel = document.getElementById('slackChannel').value;
            
            if (webhook) {
                CONFIG.SLACK_CONFIG = { webhook, channel };
                localStorage.setItem('slackConfig', JSON.stringify(CONFIG.SLACK_CONFIG));
                
                const statusEl = document.getElementById('slackStatus');
                statusEl.className = 'slack-status connected';
                statusEl.innerHTML = '<span>‚úÖ</span> Slack configurado correctamente';
                
                sendSlackNotification('Sistema OPT configurado', 
                    'Las notificaciones de Slack han sido configuradas exitosamente.');
            } else {
                alert('Por favor ingrese una URL de webhook v√°lida');
            }
        }

        // Enviar notificaci√≥n a Slack
        async function sendSlackNotification(title, message, type = 'info') {
            if (!CONFIG.SLACK_CONFIG.webhook) return;
            
            const colors = {
                'info': '#2563eb',
                'success': '#10b981',
                'warning': '#f59e0b',
                'danger': '#ef4444'
            };
            
            const payload = {
                channel: CONFIG.SLACK_CONFIG.channel || '#opt-notifications',
                username: 'Sistema OPT',
                icon_emoji: ':shield:',
                attachments: [{
                    color: colors[type] || colors.info,
                    title: title,
                    text: message,
                    footer: 'Sistema de Gesti√≥n OPT',
                    ts: Math.floor(Date.now() / 1000)
                }]
            };
            
            try {
                // En producci√≥n, esto deber√≠a ser una llamada a tu servidor backend
                console.log('Notificaci√≥n Slack:', payload);
                
                // Simulaci√≥n de env√≠o (en producci√≥n usar tu backend)
                /* 
                await fetch(CONFIG.SLACK_CONFIG.webhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                */
            } catch (error) {
                console.error('Error enviando notificaci√≥n a Slack:', error);
            }
        }

        // Modal de configuraci√≥n
        function openConfigModal() {
            document.getElementById('configModal').classList.add('active');
            
            // Mostrar estado de Slack
            if (CONFIG.SLACK_CONFIG.webhook) {
                document.getElementById('slackWebhook').value = CONFIG.SLACK_CONFIG.webhook;
                document.getElementById('slackChannel').value = CONFIG.SLACK_CONFIG.channel || '#opt-notifications';
                document.getElementById('slackStatus').className = 'slack-status connected';
                document.getElementById('slackStatus').innerHTML = '<span>‚úÖ</span> Slack configurado';
            }
        }

        function closeConfigModal() {
            document.getElementById('configModal').classList.remove('active');
        }

        // Gesti√≥n de usuarios autorizados
        function loadAuthorizedUsers() {
            const container = document.getElementById('authorizedUsersList');
            container.innerHTML = CONFIG.AUTHORIZED_USERS.map((user, index) => `
                <div style="padding: 10px; background: var(--light); border-radius: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <span>${user.username} - ${user.role}</span>
                    ${user.username !== 'admin' ? `<button class="btn btn-danger" onclick="removeAuthorizedUser(${index})">Eliminar</button>` : ''}
                </div>
            `).join('');
        }

        function addAuthorizedUser() {
            const username = document.getElementById('newUserName').value;
            if (username) {
                CONFIG.AUTHORIZED_USERS.push({
                    username: username,
                    password: username + '123',
                    role: 'user'
                });
                localStorage.setItem('authorizedUsers', JSON.stringify(CONFIG.AUTHORIZED_USERS));
                loadAuthorizedUsers();
                document.getElementById('newUserName').value = '';
                alert(`Usuario ${username} agregado. Contrase√±a: ${username}123`);
            }
        }

        function removeAuthorizedUser(index) {
            CONFIG.AUTHORIZED_USERS.splice(index, 1);
            localStorage.setItem('authorizedUsers', JSON.stringify(CONFIG.AUTHORIZED_USERS));
            loadAuthorizedUsers();
        }

        // Funci√≥n para cambiar de pesta√±a
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'incidents') {
                loadIncidentsList();
            } else if (tabName === 'developments') {
                loadDevelopmentsList();
            }
        }

        // Seleccionar tipo de solicitud
        function selectRequestType(type) {
            document.querySelectorAll('.type-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            event.currentTarget.classList.add('selected');
            document.getElementById('requestType').value = type;
            document.getElementById('commonFields').style.display = 'block';
            
            if (type === 'incident') {
                document.getElementById('incidentFields').style.display = 'block';
                document.getElementById('developmentFields').style.display = 'none';
                document.getElementById('incidentPriority').required = true;
                document.getElementById('incidentCategory').required = true;
                document.getElementById('devType').required = false;
                document.getElementById('devImpact').required = false;
            } else {
                document.getElementById('incidentFields').style.display = 'none';
                document.getElementById('developmentFields').style.display = 'block';
                document.getElementById('devType').required = true;
                document.getElementById('devImpact').required = true;
                document.getElementById('incidentPriority').required = false;
                document.getElementById('incidentCategory').required = false;
            }
        }

        // Manejar carga de im√°genes
        function handleImageUpload(event) {
            const files = event.target.files;
            const preview = document.getElementById('imagePreview');
            
            if (uploadedImages.length + files.length > 5) {
                alert('M√°ximo 5 im√°genes permitidas');
                return;
            }
            
            for (let file of files) {
                if (file.size > 5 * 1024 * 1024) {
                    alert(`${file.name} excede el l√≠mite de 5MB`);
                    continue;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result;
                    uploadedImages.push({
                        name: file.name,
                        data: imageData,
                        size: file.size
                    });
                    
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';
                    previewItem.innerHTML = `
                        <img src="${imageData}" alt="${file.name}">
                        <button class="remove-btn" onclick="removeImage(${uploadedImages.length - 1})">√ó</button>
                    `;
                    preview.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            }
        }

        // Remover imagen
        function removeImage(index) {
            uploadedImages.splice(index, 1);
            updateImagePreview();
        }

        // Actualizar vista previa de im√°genes
        function updateImagePreview() {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            
            uploadedImages.forEach((img, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'image-preview-item';
                previewItem.innerHTML = `
                    <img src="${img.data}" alt="${img.name}">
                    <button class="remove-btn" onclick="removeImage(${index})">√ó</button>
                `;
                preview.appendChild(previewItem);
            });
        }

        // Crear solicitud unificada
        function createRequest(event) {
            event.preventDefault();
            
            const type = document.getElementById('requestType').value;
            if (!type) {
                alert('Por favor seleccione el tipo de solicitud');
                return;
            }
            
            const baseData = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                department: document.getElementById('department').value,
                requester: document.getElementById('requester').value,
                images: [...uploadedImages],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
            };
            
            if (type === 'incident') {
                const newIncident = {
                    ...baseData,
                    id: `INC-${++currentIncidentId}`,
                    type: 'incident',
                    priority: document.getElementById('incidentPriority').value,
                    category: document.getElementById('incidentCategory').value,
                    steps: document.getElementById('incidentSteps').value,
                    status: 'new',
                    history: [{
                        date: new Date().toISOString(),
                        action: 'Incidencia creada',
                        user: baseData.requester
                    }]
                };
                
                incidents.push(newIncident);
                
                // Notificaci√≥n Slack
                sendSlackNotification(
                    `üêõ Nueva Incidencia: ${newIncident.id}`,
                    `*T√≠tulo:* ${newIncident.title}\n*Departamento:* ${getDepartmentLabel(newIncident.department)}\n*Prioridad:* ${getPriorityLabel(newIncident.priority)}\n*Reportado por:* ${newIncident.requester}`,
                    newIncident.priority === 'critical' ? 'danger' : 'warning'
                );
                
                alert(`‚úÖ Incidencia ${newIncident.id} creada exitosamente`);
            } else {
                const newDevelopment = {
                    ...baseData,
                    id: `DEV-${++currentDevId}`,
                    type: 'development',
                    devType: document.getElementById('devType').value,
                    impact: document.getElementById('devImpact').value,
                    expectedDate: document.getElementById('devExpectedDate').value,
                    budget: document.getElementById('devBudget').value,
                    justification: document.getElementById('devJustification').value,
                    acceptance: document.getElementById('devAcceptance').value,
                    status: 'pending',
                    history: [{
                        date: new Date().toISOString(),
                        action: 'Solicitud de desarrollo creada',
                        user: baseData.requester
                    }]
                };
                
                developments.push(newDevelopment);
                
                // Notificaci√≥n Slack
                sendSlackNotification(
                    `üöÄ Nueva Solicitud de Desarrollo: ${newDevelopment.id}`,
                    `*T√≠tulo:* ${newDevelopment.title}\n*Departamento:* ${getDepartmentLabel(newDevelopment.department)}\n*Impacto:* ${getImpactLabel(newDevelopment.impact)}\n*Solicitado por:* ${newDevelopment.requester}`,
                    newDevelopment.impact === 'critical' ? 'danger' : 'info'
                );
                
                alert(`‚úÖ Solicitud de desarrollo ${newDevelopment.id} creada exitosamente`);
            }
            
            saveData();
            
            // Limpiar formulario
            event.target.reset();
            document.getElementById('commonFields').style.display = 'none';
            document.getElementById('incidentFields').style.display = 'none';
            document.getElementById('developmentFields').style.display = 'none';
            document.getElementById('duplicateWarning').style.display = 'none';
            document.querySelectorAll('.type-card').forEach(card => {
                card.classList.remove('selected');
            });
            uploadedImages = [];
            updateImagePreview();
            
            updateDashboard();
        }

        // Verificar duplicados
        function checkDuplicates() {
            const title = document.getElementById('title').value.toLowerCase();
            if (title.length < 5) return;
            
            const allItems = [...incidents, ...developments];
            const similar = allItems.find(item => 
                item.title.toLowerCase().includes(title) || 
                title.includes(item.title.toLowerCase())
            );
            
            if (similar) {
                document.getElementById('duplicateWarning').style.display = 'block';
                document.getElementById('duplicateWarning').innerHTML = 
                    `‚ö†Ô∏è <strong>Posible duplicado detectado:</strong> "${similar.title}" (${similar.id}). Por favor, verifica antes de crear una nueva.`;
            } else {
                document.getElementById('duplicateWarning').style.display = 'none';
            }
        }

        // Solicitar m√°s informaci√≥n
        function requestMoreInfo(itemId, itemType) {
            if (!canModifyStatus()) {
                alert('‚ö†Ô∏è Necesitas autenticarte para realizar esta acci√≥n');
                openConfigModal();
                return;
            }
            
            const infoRequest = prompt('¬øQu√© informaci√≥n adicional necesitas?');
            if (!infoRequest) return;
            
            const item = itemType === 'incident' 
                ? incidents.find(i => i.id === itemId)
                : developments.find(d => d.id === itemId);
            
            if (!item) return;
            
            item.status = 'info-needed';
            item.updatedAt = new Date().toISOString();
            item.history.push({
                date: new Date().toISOString(),
                action: `Informaci√≥n adicional solicitada: ${infoRequest}`,
                user: currentUser.username
            });
            
            saveData();
            
            // Notificaci√≥n Slack
            sendSlackNotification(
                `‚ÑπÔ∏è Informaci√≥n Requerida: ${item.id}`,
                `*T√≠tulo:* ${item.title}\n*Solicitado por:* ${currentUser.username}\n*Informaci√≥n necesaria:* ${infoRequest}\n*Reportado originalmente por:* ${item.requester}`,
                'warning'
            );
            
            alert('‚úÖ Solicitud de informaci√≥n enviada');
            updateDashboard();
            loadIncidentsList();
            loadDevelopmentsList();
        }

        // Actualizar dashboard
        function updateDashboard() {
            const totalInc = incidents.length;
            const openInc = incidents.filter(i => i.status === 'new' || i.status === 'progress' || i.status === 'info-needed').length;
            const resolvedInc = incidents.filter(i => i.status === 'resolved').length;
            
            const totalDev = developments.length;
            const pendingDev = developments.filter(d => d.status === 'pending' || d.status === 'approved' || d.status === 'info-needed').length;
            const inProgressDev = developments.filter(d => d.status === 'in-progress' || d.status === 'testing').length;
            
            document.getElementById('totalIncidents').textContent = totalInc + totalDev;
            document.getElementById('openIncidents').textContent = openInc + pendingDev + inProgressDev;
            document.getElementById('resolvedIncidents').textContent = resolvedInc + developments.filter(d => d.status === 'completed').length;
            
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weekIncidents = incidents.filter(i => new Date(i.createdAt) >= weekAgo);
            const weekDevelopments = developments.filter(d => new Date(d.createdAt) >= weekAgo);
            const weekTotal = weekIncidents.length + weekDevelopments.length;
            const weekResolved = weekIncidents.filter(i => i.status === 'resolved' || i.status === 'closed').length +
                                weekDevelopments.filter(d => d.status === 'completed').length;
            const weekProgress = weekTotal > 0 ? Math.round((weekResolved / weekTotal) * 100) : 0;
            
            document.getElementById('weeklyProgress').style.width = `${weekProgress}%`;
            document.getElementById('weeklyProgress').textContent = `${weekProgress}%`;
            document.getElementById('resolvedThisWeek').textContent = weekResolved;
            document.getElementById('totalThisWeek').textContent = weekTotal;
            
            loadRecentItems();
            updateCharts();
        }

        // Cargar elementos recientes
        function loadRecentItems() {
            const container = document.getElementById('recentIncidents');
            
            const allItems = [...incidents, ...developments]
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 5);
            
            if (allItems.length === 0) {
                container.innerHTML = '<p style="color: var(--gray); text-align: center;">No hay solicitudes registradas</p>';
                return;
            }
            
            container.innerHTML = allItems.map(item => {
                if (item.type === 'development') {
                    return createDevelopmentCard(item);
                } else {
                    return createIncidentCard(item);
                }
            }).join('');
        }

        // Crear tarjeta de incidencia
        function createIncidentCard(incident) {
            const priorityClass = incident.priority;
            const hasImages = incident.images && incident.images.length > 0;
            const canModify = canModifyStatus();
            
            return `
                <div class="incident-card ${priorityClass}">
                    <div class="incident-header">
                        <div>
                            <span class="incident-id">üêõ ${incident.id}</span>
                            <h4 class="incident-title">${incident.title}</h4>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <span class="priority-badge priority-${incident.priority}">
                                ${getPriorityLabel(incident.priority)}
                            </span>
                            <span class="status-badge status-${incident.status}">
                                ${getStatusLabel(incident.status)}
                            </span>
                        </div>
                    </div>
                    <p style="color: var(--gray); margin-bottom: 10px;">${incident.description}</p>
                    <div class="incident-meta">
                        <span class="meta-item">üë§ ${incident.requester}</span>
                        <span class="meta-item">üè¢ ${getDepartmentLabel(incident.department)}</span>
                        <span class="meta-item">üìÖ ${formatDate(incident.createdAt)}</span>
                        ${hasImages ? `<span class="meta-item">üì∑ ${incident.images.length} imagen(es)</span>` : ''}
                    </div>
                    <div class="action-buttons">
                        ${canModify ? `
                            <button class="btn btn-primary" onclick="updateIncidentStatus('${incident.id}', 'progress')" 
                                ${incident.status !== 'new' && incident.status !== 'info-needed' ? 'disabled' : ''}>
                                ‚ñ∂Ô∏è Iniciar
                            </button>
                            <button class="btn btn-success" onclick="updateIncidentStatus('${incident.id}', 'resolved')"
                                ${incident.status === 'resolved' || incident.status === 'closed' ? 'disabled' : ''}>
                                ‚úÖ Resolver
                            </button>
                            <button class="btn btn-info" onclick="requestMoreInfo('${incident.id}', 'incident')">
                                ‚ÑπÔ∏è Solicitar Info
                            </button>
                        ` : ''}
                        <button class="btn btn-warning" onclick="viewIncidentDetails('${incident.id}')">
                            üëÅÔ∏è Detalles
                        </button>
                    </div>
                </div>
            `;
        }

        // Crear tarjeta de desarrollo
        function createDevelopmentCard(development) {
            const impactClass = development.impact;
            const hasImages = development.images && development.images.length > 0;
            const canModify = canModifyStatus();
            
            return `
                <div class="incident-card dev-card">
                    <div class="incident-header">
                        <div>
                            <span class="incident-id">üöÄ ${development.id}</span>
                            <h4 class="incident-title">${development.title}</h4>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <span class="type-badge">
                                ${getDevTypeLabel(development.devType)}
                            </span>
                            <span class="status-badge status-${development.status}">
                                ${getDevStatusLabel(development.status)}
                            </span>
                        </div>
                    </div>
                    <p style="color: var(--gray); margin-bottom: 10px;">${development.description}</p>
                    <div class="incident-meta">
                        <span class="meta-item">üë§ ${development.requester}</span>
                        <span class="meta-item">üè¢ ${getDepartmentLabel(development.department)}</span>
                        <span class="meta-item">üìÖ ${formatDate(development.createdAt)}</span>
                        ${development.expectedDate ? `<span class="meta-item">üìÜ Esperado: ${formatDate(development.expectedDate)}</span>` : ''}
                        ${hasImages ? `<span class="meta-item">üì∑ ${development.images.length} imagen(es)</span>` : ''}
                    </div>
                    <div style="margin-top: 10px;">
                        <span class="priority-badge priority-${development.impact}">
                            Impacto: ${getImpactLabel(development.impact)}
                        </span>
                    </div>
                    <div class="action-buttons">
                        ${canModify ? `
                            <button class="btn btn-success" onclick="updateDevelopmentStatus('${development.id}', 'approved')" 
                                ${development.status !== 'pending' && development.status !== 'info-needed' ? 'disabled' : ''}>
                                ‚úÖ Aprobar
                            </button>
                            <button class="btn btn-primary" onclick="updateDevelopmentStatus('${development.id}', 'in-progress')"
                                ${development.status !== 'approved' ? 'disabled' : ''}>
                                üöÄ Iniciar Desarrollo
                            </button>
                            <button class="btn btn-info" onclick="requestMoreInfo('${development.id}', 'development')">
                                ‚ÑπÔ∏è Solicitar Info
                            </button>
                        ` : ''}
                        <button class="btn btn-warning" onclick="viewDevelopmentDetails('${development.id}')">
                            üëÅÔ∏è Detalles
                        </button>
                    </div>
                </div>
            `;
        }

        // Actualizar estado de incidencia
        function updateIncidentStatus(incidentId, newStatus) {
            if (!canModifyStatus()) {
                alert('‚ö†Ô∏è Necesitas autenticarte para realizar esta acci√≥n');
                openConfigModal();
                return;
            }
            
            const incident = incidents.find(i => i.id === incidentId);
            if (!incident) return;
            
            const oldStatus = incident.status;
            incident.status = newStatus;
            incident.updatedAt = new Date().toISOString();
            incident.history.push({
                date: new Date().toISOString(),
                action: `Estado cambiado a: ${getStatusLabel(newStatus)}`,
                user: currentUser.username
            });
            
            saveData();
            
            // Notificaci√≥n Slack
            sendSlackNotification(
                `üîÑ Estado Actualizado: ${incident.id}`,
                `*T√≠tulo:* ${incident.title}\n*Estado anterior:* ${getStatusLabel(oldStatus)}\n*Nuevo estado:* ${getStatusLabel(newStatus)}\n*Actualizado por:* ${currentUser.username}`,
                newStatus === 'resolved' ? 'success' : 'info'
            );
            
            updateDashboard();
            loadIncidentsList();
        }

        // Actualizar estado de desarrollo
        function updateDevelopmentStatus(developmentId, newStatus) {
            if (!canModifyStatus()) {
                alert('‚ö†Ô∏è Necesitas autenticarte para realizar esta acci√≥n');
                openConfigModal();
                return;
            }
            
            const development = developments.find(d => d.id === developmentId);
            if (!development) return;
            
            const oldStatus = development.status;
            development.status = newStatus;
            development.updatedAt = new Date().toISOString();
            development.history.push({
                date: new Date().toISOString(),
                action: `Estado cambiado a: ${getDevStatusLabel(newStatus)}`,
                user: currentUser.username
            });
            
            saveData();
            
            // Notificaci√≥n Slack
            sendSlackNotification(
                `üîÑ Estado Actualizado: ${development.id}`,
                `*T√≠tulo:* ${development.title}\n*Estado anterior:* ${getDevStatusLabel(oldStatus)}\n*Nuevo estado:* ${getDevStatusLabel(newStatus)}\n*Actualizado por:* ${currentUser.username}`,
                newStatus === 'completed' ? 'success' : 'info'
            );
            
            updateDashboard();
            loadDevelopmentsList();
        }

        // Ver detalles de incidencia
        function viewIncidentDetails(incidentId) {
            const incident = incidents.find(i => i.id === incidentId);
            if (!incident) return;
            
            const timeline = incident.history.map(h => `
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <div class="timeline-date">${formatDate(h.date)}</div>
                        <div class="timeline-text">${h.action} - ${h.user}</div>
                    </div>
                </div>
            `).join('');
            
            const imageGallery = incident.images && incident.images.length > 0 
                ? `<h4 style="margin-top: 20px;">Im√°genes Adjuntas</h4>
                   <div class="image-gallery">
                       ${incident.images.map(img => `<img src="${img.data}" alt="${img.name}" onclick="window.open('${img.data}', '_blank')">`).join('')}
                   </div>`
                : '';
            
            const details = `
                <div style="padding: 20px;">
                    <h3>üêõ ${incident.title}</h3>
                    <p><strong>ID:</strong> ${incident.id}</p>
                    <p><strong>Departamento:</strong> <span class="department-badge">${getDepartmentLabel(incident.department)}</span></p>
                    <p><strong>Descripci√≥n:</strong> ${incident.description}</p>
                    <p><strong>Prioridad:</strong> ${getPriorityLabel(incident.priority)}</p>
                    <p><strong>Estado:</strong> ${getStatusLabel(incident.status)}</p>
                    <p><strong>Reportado por:</strong> ${incident.requester}</p>
                    <p><strong>Pasos para reproducir:</strong></p>
                    <pre style="background: #f3f4f6; padding: 10px; border-radius: 5px;">${incident.steps || 'No especificados'}</pre>
                    
                    ${imageGallery}
                    
                    <h4 style="margin-top: 20px;">Historial de Cambios</h4>
                    <div class="timeline">${timeline}</div>
                </div>
            `;
            
            showModal(details);
        }

        // Ver detalles de desarrollo
        function viewDevelopmentDetails(developmentId) {
            const development = developments.find(d => d.id === developmentId);
            if (!development) return;
            
            const timeline = development.history.map(h => `
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <div class="timeline-date">${formatDate(h.date)}</div>
                        <div class="timeline-text">${h.action} - ${h.user}</div>
                    </div>
                </div>
            `).join('');
            
            const imageGallery = development.images && development.images.length > 0 
                ? `<h4 style="margin-top: 20px;">Im√°genes de Referencia</h4>
                   <div class="image-gallery">
                       ${development.images.map(img => `<img src="${img.data}" alt="${img.name}" onclick="window.open('${img.data}', '_blank')">`).join('')}
                   </div>`
                : '';
            
            const details = `
                <div style="padding: 20px;">
                    <h3>üöÄ ${development.title}</h3>
                    <p><strong>ID:</strong> ${development.id}</p>
                    <p><strong>Departamento:</strong> <span class="department-badge">${getDepartmentLabel(development.department)}</span></p>
                    <p><strong>Tipo:</strong> ${getDevTypeLabel(development.devType)}</p>
                    <p><strong>Descripci√≥n:</strong> ${development.description}</p>
                    <p><strong>Impacto en Negocio:</strong> ${getImpactLabel(development.impact)}</p>
                    <p><strong>Estado:</strong> ${getDevStatusLabel(development.status)}</p>
                    <p><strong>Solicitado por:</strong> ${development.requester}</p>
                    <p><strong>Fecha Esperada:</strong> ${development.expectedDate ? formatDate(development.expectedDate) : 'No especificada'}</p>
                    <p><strong>Presupuesto:</strong> ${development.budget || 'No especificado'}</p>
                    
                    <h4 style="margin-top: 15px;">Justificaci√≥n del Negocio</h4>
                    <p style="background: #f3f4f6; padding: 10px; border-radius: 5px;">${development.justification || 'No especificada'}</p>
                    
                    <h4 style="margin-top: 15px;">Criterios de Aceptaci√≥n</h4>
                    <p style="background: #f3f4f6; padding: 10px; border-radius: 5px;">${development.acceptance || 'No especificados'}</p>
                    
                    ${imageGallery}
                    
                    <h4 style="margin-top: 20px;">Historial de Cambios</h4>
                    <div class="timeline">${timeline}</div>
                </div>
            `;
            
            showModal(details);
        }

        // Mostrar modal
        function showModal(content) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    ${content}
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Cerrar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Cargar lista de incidencias
        function loadIncidentsList() {
            const container = document.getElementById('incidentsList');
            const filtered = filterIncidents();
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="color: var(--gray); text-align: center;">No hay incidencias que coincidan con los filtros</p>';
                return;
            }
            
            container.innerHTML = filtered.map(incident => createIncidentCard(incident)).join('');
        }

        // Cargar lista de desarrollos
        function loadDevelopmentsList() {
            const container = document.getElementById('developmentsList');
            const filtered = filterDevelopments();
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="color: var(--gray); text-align: center;">No hay desarrollos que coincidan con los filtros</p>';
                return;
            }
            
            container.innerHTML = filtered.map(development => createDevelopmentCard(development)).join('');
        }

        // Filtrar incidencias
        function filterIncidents() {
            const statusFilter = document.getElementById('filterStatus')?.value;
            const priorityFilter = document.getElementById('filterPriority')?.value;
            const departmentFilter = document.getElementById('filterDepartment')?.value;
            
            let filtered = [...incidents];
            
            if (statusFilter) {
                filtered = filtered.filter(i => i.status === statusFilter);
            }
            
            if (priorityFilter) {
                filtered = filtered.filter(i => i.priority === priorityFilter);
            }
            
            if (departmentFilter) {
                filtered = filtered.filter(i => i.department === departmentFilter);
            }
            
            return filtered.reverse();
        }

        // Filtrar desarrollos
        function filterDevelopments() {
            const statusFilter = document.getElementById('filterDevStatus')?.value;
            const typeFilter = document.getElementById('filterDevType')?.value;
            const departmentFilter = document.getElementById('filterDevDepartment')?.value;
            
            let filtered = [...developments];
            
            if (statusFilter) {
                filtered = filtered.filter(d => d.status === statusFilter);
            }
            
            if (typeFilter) {
                filtered = filtered.filter(d => d.devType === typeFilter);
            }
            
            if (departmentFilter) {
                filtered = filtered.filter(d => d.department === departmentFilter);
            }
            
            return filtered.reverse();
        }

        // Generar reporte
        function generateReport() {
            const startDate = new Date(document.getElementById('reportStartDate').value || new Date().setDate(new Date().getDate() - 7));
            const endDate = new Date(document.getElementById('reportEndDate').value || new Date());
            const deptFilter = document.getElementById('reportDepartment').value;
            
            let periodIncidents = incidents.filter(i => {
                const date = new Date(i.createdAt);
                return date >= startDate && date <= endDate;
            });
            
            let periodDevelopments = developments.filter(d => {
                const date = new Date(d.createdAt);
                return date >= startDate && date <= endDate;
            });
            
            if (deptFilter) {
                periodIncidents = periodIncidents.filter(i => i.department === deptFilter);
                periodDevelopments = periodDevelopments.filter(d => d.department === deptFilter);
            }
            
            // Generar resumen por departamento
            const deptSummary = {};
            [...periodIncidents, ...periodDevelopments].forEach(item => {
                const dept = getDepartmentLabel(item.department);
                if (!deptSummary[dept]) {
                    deptSummary[dept] = {
                        incidents: 0,
                        developments: 0,
                        total: 0
                    };
                }
                deptSummary[dept].total++;
                if (item.type === 'incident') {
                    deptSummary[dept].incidents++;
                } else {
                    deptSummary[dept].developments++;
                }
            });
            
            const summary = {
                totalIncidents: periodIncidents.length,
                totalDevelopments: periodDevelopments.length,
                newInc: periodIncidents.filter(i => i.status === 'new').length,
                progressInc: periodIncidents.filter(i => i.status === 'progress').length,
                infoNeededInc: periodIncidents.filter(i => i.status === 'info-needed').length,
                resolvedInc: periodIncidents.filter(i => i.status === 'resolved').length,
                closedInc: periodIncidents.filter(i => i.status === 'closed').length,
                pendingDev: periodDevelopments.filter(d => d.status === 'pending').length,
                approvedDev: periodDevelopments.filter(d => d.status === 'approved').length,
                inProgressDev: periodDevelopments.filter(d => d.status === 'in-progress').length,
                infoNeededDev: periodDevelopments.filter(d => d.status === 'info-needed').length,
                testingDev: periodDevelopments.filter(d => d.status === 'testing').length,
                completedDev: periodDevelopments.filter(d => d.status === 'completed').length
            };
            
            // Mostrar resumen
            document.getElementById('reportSummary').innerHTML = `
                <h4 style="margin-bottom: 15px; color: var(--primary);">üìä Resumen por Departamento</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    ${Object.entries(deptSummary).map(([dept, data]) => `
                        <div style="background: var(--light); padding: 15px; border-radius: 8px;">
                            <strong>${dept}</strong><br>
                            Total: ${data.total}<br>
                            Incidencias: ${data.incidents}<br>
                            Desarrollos: ${data.developments}
                        </div>
                    `).join('')}
                </div>
                
                <h4 style="margin-bottom: 15px; color: var(--primary);">üìä Resumen de Incidencias</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div><strong>Total:</strong> ${summary.totalIncidents}</div>
                    <div><strong>Nuevas:</strong> ${summary.newInc}</div>
                    <div><strong>En Progreso:</strong> ${summary.progressInc}</div>
                    <div><strong>Info Requerida:</strong> ${summary.infoNeededInc}</div>
                    <div><strong>Resueltas:</strong> ${summary.resolvedInc}</div>
                    <div><strong>Cerradas:</strong> ${summary.closedInc}</div>
                </div>
                
                <h4 style="margin-bottom: 15px; color: var(--primary);">üöÄ Resumen de Desarrollos</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div><strong>Total:</strong> ${summary.totalDevelopments}</div>
                    <div><strong>Pendientes:</strong> ${summary.pendingDev}</div>
                    <div><strong>Aprobados:</strong> ${summary.approvedDev}</div>
                    <div><strong>En Desarrollo:</strong> ${summary.inProgressDev}</div>
                    <div><strong>Info Requerida:</strong> ${summary.infoNeededDev}</div>
                    <div><strong>En Pruebas:</strong> ${summary.testingDev}</div>
                    <div><strong>Completados:</strong> ${summary.completedDev}</div>
                </div>
            `;
            
            // Calcular m√©tricas
            const resolvedItems = [...periodIncidents.filter(i => i.status === 'resolved' || i.status === 'closed'),
                                  ...periodDevelopments.filter(d => d.status === 'completed')];
            
            const avgResolutionTime = resolvedItems.length > 0 
                ? resolvedItems.reduce((acc, item) => {
                    const created = new Date(item.createdAt);
                    const updated = new Date(item.updatedAt);
                    return acc + (updated - created) / (1000 * 60 * 60 * 24);
                }, 0) / resolvedItems.length
                : 0;
            
            const totalItems = summary.totalIncidents + summary.totalDevelopments;
            
            document.getElementById('reportMetrics').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <strong>Tasa de Resoluci√≥n General:</strong> 
                        ${totalItems > 0 ? Math.round((resolvedItems.length / totalItems) * 100) : 0}%
                    </div>
                    <div>
                        <strong>Tiempo Promedio de Resoluci√≥n:</strong> 
                        ${avgResolutionTime.toFixed(1)} d√≠as
                    </div>
                    <div>
                        <strong>Items Pendientes:</strong> 
                        ${totalItems - resolvedItems.length}
                    </div>
                    <div>
                        <strong>Total de Elementos:</strong> 
                        ${totalItems}
                    </div>
                </div>
            `;
            
            // Mostrar detalle
            const allPeriodItems = [...periodIncidents, ...periodDevelopments]
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            document.getElementById('reportDetails').innerHTML = allPeriodItems.length > 0
                ? `<table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--light);">
                            <th style="padding: 10px; text-align: left;">Tipo</th>
                            <th style="padding: 10px; text-align: left;">ID</th>
                            <th style="padding: 10px; text-align: left;">T√≠tulo</th>
                            <th style="padding: 10px; text-align: left;">Departamento</th>
                            <th style="padding: 10px; text-align: left;">Prioridad/Impacto</th>
                            <th style="padding: 10px; text-align: left;">Estado</th>
                            <th style="padding: 10px; text-align: left;">Fecha</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allPeriodItems.map(item => `
                            <tr style="border-bottom: 1px solid var(--light);">
                                <td style="padding: 10px;">
                                    ${item.type === 'development' ? 'üöÄ Desarrollo' : 'üêõ Incidencia'}
                                </td>
                                <td style="padding: 10px;">${item.id}</td>
                                <td style="padding: 10px;">${item.title}</td>
                                <td style="padding: 10px;">
                                    <span class="department-badge">${getDepartmentLabel(item.department)}</span>
                                </td>
                                <td style="padding: 10px;">
                                    ${item.type === 'development' 
                                        ? `<span class="priority-badge priority-${item.impact}">${getImpactLabel(item.impact)}</span>`
                                        : `<span class="priority-badge priority-${item.priority}">${getPriorityLabel(item.priority)}</span>`
                                    }
                                </td>
                                <td style="padding: 10px;">
                                    <span class="status-badge status-${item.status}">
                                        ${item.type === 'development' ? getDevStatusLabel(item.status) : getStatusLabel(item.status)}
                                    </span>
                                </td>
                                <td style="padding: 10px;">${formatDate(item.createdAt)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`
                : '<p style="color: var(--gray); text-align: center;">No hay elementos en el per√≠odo seleccionado</p>';
            
            document.getElementById('reportContent').style.display = 'block';
        }

        // Exportar reporte a CSV
        function exportReport() {
            const startDate = new Date(document.getElementById('reportStartDate').value || new Date().setDate(new Date().getDate() - 7));
            const endDate = new Date(document.getElementById('reportEndDate').value || new Date());
            const deptFilter = document.getElementById('reportDepartment').value;
            
            let periodIncidents = incidents.filter(i => {
                const date = new Date(i.createdAt);
                return date >= startDate && date <= endDate;
            });
            
            let periodDevelopments = developments.filter(d => {
                const date = new Date(d.createdAt);
                return date >= startDate && date <= endDate;
            });
            
            if (deptFilter) {
                periodIncidents = periodIncidents.filter(i => i.department === deptFilter);
                periodDevelopments = periodDevelopments.filter(d => d.department === deptFilter);
            }
            
            // Crear CSV
            let csv = 'Tipo,ID,T√≠tulo,Departamento,Descripci√≥n,Prioridad/Impacto,Estado,Categor√≠a/Tipo,Solicitante,Fecha Creaci√≥n,√öltima Actualizaci√≥n,Im√°genes\n';
            
            periodIncidents.forEach(i => {
                const imageCount = i.images ? i.images.length : 0;
                csv += `"Incidencia","${i.id}","${i.title}","${getDepartmentLabel(i.department)}","${i.description}","${getPriorityLabel(i.priority)}","${getStatusLabel(i.status)}","${i.category}","${i.requester}","${formatDate(i.createdAt)}","${formatDate(i.updatedAt)}","${imageCount} imagen(es)"\n`;
            });
            
            periodDevelopments.forEach(d => {
                const imageCount = d.images ? d.images.length : 0;
                csv += `"Desarrollo","${d.id}","${d.title}","${getDepartmentLabel(d.department)}","${d.description}","${getImpactLabel(d.impact)}","${getDevStatusLabel(d.status)}","${getDevTypeLabel(d.devType)}","${d.requester}","${formatDate(d.createdAt)}","${formatDate(d.updatedAt)}","${imageCount} imagen(es)"\n`;
            });
            
            // Descargar archivo
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `reporte_opt_${formatDate(new Date(), 'file')}.csv`;
            link.click();
        }

        // Actualizar gr√°ficos
        function updateCharts() {
            const allNew = incidents.filter(i => i.status === 'new').length + 
                          developments.filter(d => d.status === 'pending').length;
            const allInProgress = incidents.filter(i => i.status === 'progress').length + 
                                developments.filter(d => d.status === 'in-progress' || d.status === 'approved').length;
            const allInfoNeeded = incidents.filter(i => i.status === 'info-needed').length + 
                                 developments.filter(d => d.status === 'info-needed').length;
            const allResolved = incidents.filter(i => i.status === 'resolved').length + 
                              developments.filter(d => d.status === 'completed').length;
            const allClosed = incidents.filter(i => i.status === 'closed').length + 
                            developments.filter(d => d.status === 'cancelled').length;
            
            drawPieChart('statusChart', {
                'Nuevos/Pendientes': allNew,
                'En Progreso': allInProgress,
                'Info Requerida': allInfoNeeded,
                'Resueltos/Completados': allResolved,
                'Cerrados/Cancelados': allClosed
            }, ['#3b82f6', '#f59e0b', '#8b5cf6', '#10b981', '#6b7280']);
            
            const allCritical = incidents.filter(i => i.priority === 'critical').length + 
                               developments.filter(d => d.impact === 'critical').length;
            const allHigh = incidents.filter(i => i.priority === 'high').length + 
                          developments.filter(d => d.impact === 'high').length;
            const allMedium = incidents.filter(i => i.priority === 'medium').length + 
                            developments.filter(d => d.impact === 'medium').length;
            const allLow = incidents.filter(i => i.priority === 'low').length + 
                         developments.filter(d => d.impact === 'low').length;
            
            drawPieChart('priorityChart', {
                'Cr√≠tica': allCritical,
                'Alta': allHigh,
                'Media': allMedium,
                'Baja': allLow
            }, ['#ef4444', '#f59e0b', '#3b82f6', '#10b981']);
            
            drawTrendChart();
        }

        // Dibujar gr√°fico de pastel
        function drawPieChart(canvasId, data, colors) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const total = Object.values(data).reduce((a, b) => a + b, 0);
            
            if (total === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#6b7280';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Sin datos', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            let currentAngle = -Math.PI / 2;
            const centerX = 100;
            const centerY = 100;
            const radius = 70;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            Object.entries(data).forEach(([label, value], index) => {
                const sliceAngle = (value / total) * 2 * Math.PI;
                
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.lineTo(centerX, centerY);
                ctx.fillStyle = colors[index];
                ctx.fill();
                
                const labelX = centerX + Math.cos(currentAngle + sliceAngle / 2) * (radius + 20);
                const labelY = centerY + Math.sin(currentAngle + sliceAngle / 2) * (radius + 20);
                
                ctx.fillStyle = '#374151';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${label}: ${value}`, labelX + 100, labelY);
                
                currentAngle += sliceAngle;
            });
        }

        // Dibujar gr√°fico de tendencia
        function drawTrendChart() {
            const canvas = document.getElementById('trendChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const days = [];
            const incidentCounts = [];
            const developmentCounts = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                date.setHours(0, 0, 0, 0);
                
                const nextDate = new Date(date);
                nextDate.setDate(nextDate.getDate() + 1);
                
                const dayIncidents = incidents.filter(inc => {
                    const incDate = new Date(inc.createdAt);
                    return incDate >= date && incDate < nextDate;
                });
                
                const dayDevelopments = developments.filter(dev => {
                    const devDate = new Date(dev.createdAt);
                    return devDate >= date && devDate < nextDate;
                });
                
                days.push(date.toLocaleDateString('es', { weekday: 'short' }));
                incidentCounts.push(dayIncidents.length);
                developmentCounts.push(dayDevelopments.length);
            }
            
            const maxCount = Math.max(...incidentCounts, ...developmentCounts, 1);
            const chartWidth = 350;
            const chartHeight = 150;
            const barWidth = chartWidth / 14;
            
            days.forEach((day, index) => {
                const incHeight = (incidentCounts[index] / maxCount) * chartHeight;
                const incX = index * barWidth * 2 + 25;
                const incY = chartHeight - incHeight + 20;
                
                ctx.fillStyle = '#ef4444';
                ctx.fillRect(incX, incY, barWidth - 5, incHeight);
                
                const devHeight = (developmentCounts[index] / maxCount) * chartHeight;
                const devX = incX + barWidth;
                const devY = chartHeight - devHeight + 20;
                
                ctx.fillStyle = '#8b5cf6';
                ctx.fillRect(devX, devY, barWidth - 5, devHeight);
                
                ctx.fillStyle = '#374151';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                
                if (incidentCounts[index] > 0) {
                    ctx.fillText(incidentCounts[index], incX + (barWidth - 5) / 2, incY - 5);
                }
                if (developmentCounts[index] > 0) {
                    ctx.fillText(developmentCounts[index], devX + (barWidth - 5) / 2, devY - 5);
                }
                
                ctx.font = '11px Arial';
                ctx.fillText(day, incX + barWidth - 2.5, chartHeight + 35);
            });
            
            ctx.fillStyle = '#ef4444';
            ctx.fillRect(320, 10, 15, 15);
            ctx.fillStyle = '#374151';
            ctx.font = '12px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('Errores', 340, 22);
            
            ctx.fillStyle = '#8b5cf6';
            ctx.fillRect(320, 30, 15, 15);
            ctx.fillStyle = '#374151';
            ctx.fillText('Desarrollos', 340, 42);
        }

        // Funciones auxiliares
        function getPriorityLabel(priority) {
            const labels = {
                'critical': 'Cr√≠tica',
                'high': 'Alta',
                'medium': 'Media',
                'low': 'Baja'
            };
            return labels[priority] || priority;
        }

        function getStatusLabel(status) {
            const labels = {
                'new': 'Nuevo',
                'progress': 'En Progreso',
                'info-needed': 'Info Requerida',
                'resolved': 'Resuelto',
                'closed': 'Cerrado'
            };
            return labels[status] || status;
        }

        function getDevStatusLabel(status) {
            const labels = {
                'pending': 'Pendiente',
                'approved': 'Aprobado',
                'in-progress': 'En Desarrollo',
                'info-needed': 'Info Requerida',
                'testing': 'En Pruebas',
                'completed': 'Completado',
                'cancelled': 'Cancelado'
            };
            return labels[status] || status;
        }

        function getDevTypeLabel(type) {
            const labels = {
                'new-feature': 'Nueva Funcionalidad',
                'improvement': 'Mejora',
                'integration': 'Integraci√≥n',
                'report': 'Reporte',
                'automation': 'Automatizaci√≥n',
                'ui-change': 'Cambio UI',
                'api': 'API',
                'migration': 'Migraci√≥n',
                'other': 'Otro'
            };
            return labels[type] || type;
        }

        function getImpactLabel(impact) {
            const labels = {
                'critical': 'Cr√≠tico',
                'high': 'Alto',
                'medium': 'Medio',
                'low': 'Bajo'
            };
            return labels[impact] || impact;
        }

        function getDepartmentLabel(department) {
            const labels = {
                'support-emea': 'Support EMEA',
                'support-amer': 'Support AMER',
                'support-apac': 'Support APAC',
                'sales': 'SALES',
                'qa': 'QA',
                'training': 'TRAINING',
                'other': 'OTRO'
            };
            return labels[department] || department;
        }

        function formatDate(dateString, format = 'display') {
            const date = new Date(dateString);
            if (format === 'file') {
                return date.toISOString().split('T')[0];
            }
            return date.toLocaleDateString('es', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Drag and drop para im√°genes
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.querySelector('.image-upload');
            if (uploadArea) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, highlight, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, unhighlight, false);
                });
                
                function highlight(e) {
                    uploadArea.style.borderColor = 'var(--primary)';
                    uploadArea.style.background = 'rgba(37, 99, 235, 0.05)';
                }
                
                function unhighlight(e) {
                    uploadArea.style.borderColor = 'var(--gray)';
                    uploadArea.style.background = 'var(--light)';
                }
                
                uploadArea.addEventListener('drop', handleDrop, false);
                
                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    document.getElementById('imageInput').files = files;
                    handleImageUpload({target: {files: files}});
                }
            }
            
            // Cargar usuario guardado
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('currentUser').textContent = currentUser.username;
                document.getElementById('userRole').textContent = currentUser.role.toUpperCase();
                document.getElementById('userRole').style.display = 'inline';
            }
            
            // Cargar usuarios autorizados guardados
            const savedAuthorizedUsers = localStorage.getItem('authorizedUsers');
            if (savedAuthorizedUsers) {
                CONFIG.AUTHORIZED_USERS = JSON.parse(savedAuthorizedUsers);
            }
            
            // Establecer fechas por defecto
            const today = new Date();
            const weekAgo = new Date();
            weekAgo.setDate(today.getDate() - 7);
            
            document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
            document.getElementById('reportStartDate').value = weekAgo.toISOString().split('T')[0];
            
            // Cargar dashboard inicial
            updateDashboard();
        });
    </script>
</body>
</html>
