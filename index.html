<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Incidencias - OPT</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --gray: #6b7280;
            --light: #f3f4f6;
            --white: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--light);
        }

        .header h1 {
            color: var(--dark);
            font-size: 2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header .stats {
            display: flex;
            gap: 20px;
        }

        .stat-card {
            background: var(--white);
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-card .label {
            color: var(--gray);
            font-size: 0.9em;
            margin-top: 5px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--light);
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            position: relative;
            transition: all 0.3s;
        }

        .tab.active {
            color: var(--primary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            border-radius: 3px 3px 0 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-section {
            background: var(--white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid var(--light);
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .incidents-grid {
            display: grid;
            gap: 20px;
        }

        .incident-card {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            border-left: 4px solid var(--gray);
        }

        .incident-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .incident-card.critical {
            border-left-color: var(--danger);
        }

        .incident-card.high {
            border-left-color: var(--warning);
        }

        .incident-card.medium {
            border-left-color: var(--primary);
        }

        .incident-card.low {
            border-left-color: var(--success);
        }

        .incident-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .incident-id {
            font-weight: bold;
            color: var(--primary);
            font-size: 0.9em;
        }

        .incident-title {
            font-size: 1.2em;
            color: var(--dark);
            margin: 5px 0;
        }

        .incident-meta {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--gray);
            font-size: 0.9em;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .status-new {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-progress {
            background: #fef3c7;
            color: #92400e;
        }

        .status-resolved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-closed {
            background: #e5e7eb;
            color: #374151;
        }

        .priority-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .priority-critical {
            background: #fee2e2;
            color: #991b1b;
        }

        .priority-high {
            background: #fed7aa;
            color: #9a3412;
        }

        .priority-medium {
            background: #dbeafe;
            color: #1e40af;
        }

        .priority-low {
            background: #d1fae5;
            color: #065f46;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .chart-card {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .chart-card h3 {
            color: var(--dark);
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: var(--light);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .filters-section {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--gray);
            font-size: 0.9em;
        }

        .filter-group select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid var(--light);
            border-radius: 8px;
            background: white;
        }

        .duplicate-warning {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            color: #92400e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .timeline {
            margin-top: 20px;
        }

        .timeline-item {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            position: relative;
        }

        .timeline-marker {
            width: 12px;
            height: 12px;
            background: var(--primary);
            border-radius: 50%;
            margin-top: 5px;
            position: relative;
        }

        .timeline-item:not(:last-child) .timeline-marker::after {
            content: '';
            position: absolute;
            top: 12px;
            left: 5px;
            width: 2px;
            height: 40px;
            background: var(--light);
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-date {
            color: var(--gray);
            font-size: 0.85em;
        }

        .timeline-text {
            color: var(--dark);
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
            }

            .header .stats {
                width: 100%;
                justify-content: space-between;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .charts-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span>üõ°Ô∏è</span> Sistema de Gesti√≥n de Incidencias OPT
            </h1>
            <div class="stats">
                <div class="stat-card">
                    <div class="value" id="totalIncidents">0</div>
                    <div class="label">Total</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="openIncidents">0</div>
                    <div class="label">Abiertas</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="resolvedIncidents">0</div>
                    <div class="label">Resueltas</div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('newIncident')">‚ûï Nuevo Reporte</button>
            <button class="tab" onclick="switchTab('incidents')">üìã Incidencias</button>
            <button class="tab" onclick="switchTab('reports')">üìà Reportes</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="charts-container">
                <div class="chart-card">
                    <h3>Estado de Incidencias</h3>
                    <canvas id="statusChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Prioridades</h3>
                    <canvas id="priorityChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Progreso Semanal</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="weeklyProgress" style="width: 0%">
                            0%
                        </div>
                    </div>
                    <p style="margin-top: 10px; color: var(--gray);">
                        <span id="resolvedThisWeek">0</span> de <span id="totalThisWeek">0</span> incidencias resueltas esta semana
                    </p>
                </div>
                <div class="chart-card">
                    <h3>Tendencia Semanal</h3>
                    <canvas id="trendChart" width="400" height="200"></canvas>
                </div>
            </div>

            <h3 style="margin-top: 30px; margin-bottom: 20px; color: var(--dark);">Incidencias Recientes</h3>
            <div id="recentIncidents" class="incidents-grid">
                <!-- Incidencias recientes se cargar√°n aqu√≠ -->
            </div>
        </div>

        <!-- Nuevo Reporte Tab -->
        <div id="newIncident" class="tab-content">
            <div class="duplicate-warning" id="duplicateWarning">
                ‚ö†Ô∏è <strong>Posible duplicado detectado:</strong> Ya existe una incidencia similar. Por favor, verifica antes de crear una nueva.
            </div>

            <form class="form-section" onsubmit="createIncident(event)">
                <h3 style="margin-bottom: 20px; color: var(--dark);">Reportar Nueva Incidencia</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>T√≠tulo *</label>
                        <input type="text" id="incidentTitle" required placeholder="Breve descripci√≥n del error" oninput="checkDuplicates()">
                    </div>
                    <div class="form-group">
                        <label>Proyecto *</label>
                        <input type="text" id="incidentProject" required placeholder="Nombre del proyecto">
                    </div>
                </div>

                <div class="form-group">
                    <label>Descripci√≥n Detallada *</label>
                    <textarea id="incidentDescription" required placeholder="Describe el error con el mayor detalle posible"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Prioridad *</label>
                        <select id="incidentPriority" required>
                            <option value="">Seleccionar...</option>
                            <option value="critical">Cr√≠tica - Sistema inoperativo</option>
                            <option value="high">Alta - Funcionalidad mayor afectada</option>
                            <option value="medium">Media - Funcionalidad menor afectada</option>
                            <option value="low">Baja - Problema cosm√©tico</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Categor√≠a *</label>
                        <select id="incidentCategory" required>
                            <option value="">Seleccionar...</option>
                            <option value="bug">Error/Bug</option>
                            <option value="performance">Rendimiento</option>
                            <option value="security">Seguridad</option>
                            <option value="ui">Interfaz de Usuario</option>
                            <option value="data">Datos</option>
                            <option value="integration">Integraci√≥n</option>
                            <option value="other">Otro</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Reportado por *</label>
                        <input type="text" id="incidentReporter" required placeholder="Tu nombre">
                    </div>
                    <div class="form-group">
                        <label>Email de contacto</label>
                        <input type="email" id="incidentEmail" placeholder="correo@ejemplo.com">
                    </div>
                </div>

                <div class="form-group">
                    <label>Pasos para Reproducir</label>
                    <textarea id="incidentSteps" placeholder="1. Paso uno&#10;2. Paso dos&#10;3. ..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary">
                    <span>üìù</span> Crear Reporte
                </button>
            </form>
        </div>

        <!-- Lista de Incidencias Tab -->
        <div id="incidents" class="tab-content">
            <div class="filters-section">
                <div class="filter-group">
                    <label>Estado</label>
                    <select id="filterStatus" onchange="filterIncidents()">
                        <option value="">Todos</option>
                        <option value="new">Nuevo</option>
                        <option value="progress">En Progreso</option>
                        <option value="resolved">Resuelto</option>
                        <option value="closed">Cerrado</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Prioridad</label>
                    <select id="filterPriority" onchange="filterIncidents()">
                        <option value="">Todas</option>
                        <option value="critical">Cr√≠tica</option>
                        <option value="high">Alta</option>
                        <option value="medium">Media</option>
                        <option value="low">Baja</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Proyecto</label>
                    <select id="filterProject" onchange="filterIncidents()">
                        <option value="">Todos</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="filterIncidents()">
                    üîç Aplicar Filtros
                </button>
            </div>

            <div id="incidentsList" class="incidents-grid">
                <!-- Lista de incidencias se cargar√° aqu√≠ -->
            </div>
        </div>

        <!-- Reportes Tab -->
        <div id="reports" class="tab-content">
            <div class="form-section">
                <h3 style="margin-bottom: 20px; color: var(--dark);">Generar Reporte Semanal</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Desde</label>
                        <input type="date" id="reportStartDate">
                    </div>
                    <div class="form-group">
                        <label>Hasta</label>
                        <input type="date" id="reportEndDate">
                    </div>
                </div>

                <button class="btn btn-primary" onclick="generateReport()">
                    üìä Generar Reporte
                </button>
                <button class="btn btn-success" onclick="exportReport()" style="margin-left: 10px;">
                    üíæ Exportar CSV
                </button>
            </div>

            <div id="reportContent" style="display: none;">
                <div class="form-section" style="margin-top: 20px;">
                    <h3 style="margin-bottom: 20px; color: var(--dark);">Resumen del Per√≠odo</h3>
                    <div id="reportSummary"></div>
                </div>

                <div class="form-section" style="margin-top: 20px;">
                    <h3 style="margin-bottom: 20px; color: var(--dark);">M√©tricas de Resoluci√≥n</h3>
                    <div id="reportMetrics"></div>
                </div>

                <div class="form-section" style="margin-top: 20px;">
                    <h3 style="margin-bottom: 20px; color: var(--dark);">Detalle de Incidencias</h3>
                    <div id="reportDetails"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Base de datos local de incidencias
        let incidents = JSON.parse(localStorage.getItem('incidents') || '[]');
        let currentIncidentId = parseInt(localStorage.getItem('lastIncidentId') || '1000');

        // Funci√≥n para guardar datos
        function saveData() {
            localStorage.setItem('incidents', JSON.stringify(incidents));
            localStorage.setItem('lastIncidentId', currentIncidentId.toString());
        }

        // Funci√≥n para cambiar de pesta√±a
        function switchTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Desactivar todos los tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Activar la pesta√±a seleccionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Cargar contenido espec√≠fico de la pesta√±a
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'incidents') {
                loadIncidentsList();
            }
        }

        // Funci√≥n para crear una nueva incidencia
        function createIncident(event) {
            event.preventDefault();
            
            const newIncident = {
                id: `INC-${++currentIncidentId}`,
                title: document.getElementById('incidentTitle').value,
                project: document.getElementById('incidentProject').value,
                description: document.getElementById('incidentDescription').value,
                priority: document.getElementById('incidentPriority').value,
                category: document.getElementById('incidentCategory').value,
                reporter: document.getElementById('incidentReporter').value,
                email: document.getElementById('incidentEmail').value,
                steps: document.getElementById('incidentSteps').value,
                status: 'new',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                history: [{
                    date: new Date().toISOString(),
                    action: 'Incidencia creada',
                    user: document.getElementById('incidentReporter').value
                }]
            };
            
            incidents.push(newIncident);
            saveData();
            
            // Limpiar formulario
            event.target.reset();
            document.getElementById('duplicateWarning').style.display = 'none';
            
            // Mostrar mensaje de √©xito
            alert(`‚úÖ Incidencia ${newIncident.id} creada exitosamente`);
            
            // Actualizar dashboard
            updateDashboard();
        }

        // Funci√≥n para verificar duplicados
        function checkDuplicates() {
            const title = document.getElementById('incidentTitle').value.toLowerCase();
            if (title.length < 5) return;
            
            const similar = incidents.find(inc => 
                inc.title.toLowerCase().includes(title) || 
                title.includes(inc.title.toLowerCase())
            );
            
            if (similar) {
                document.getElementById('duplicateWarning').style.display = 'block';
                document.getElementById('duplicateWarning').innerHTML = 
                    `‚ö†Ô∏è <strong>Posible duplicado detectado:</strong> "${similar.title}" (${similar.id}). Por favor, verifica antes de crear una nueva.`;
            } else {
                document.getElementById('duplicateWarning').style.display = 'none';
            }
        }

        // Funci√≥n para actualizar el dashboard
        function updateDashboard() {
            // Actualizar estad√≠sticas
            const total = incidents.length;
            const open = incidents.filter(i => i.status === 'new' || i.status === 'progress').length;
            const resolved = incidents.filter(i => i.status === 'resolved').length;
            
            document.getElementById('totalIncidents').textContent = total;
            document.getElementById('openIncidents').textContent = open;
            document.getElementById('resolvedIncidents').textContent = resolved;
            
            // Actualizar progreso semanal
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weekIncidents = incidents.filter(i => new Date(i.createdAt) >= weekAgo);
            const weekResolved = weekIncidents.filter(i => i.status === 'resolved' || i.status === 'closed').length;
            const weekProgress = weekIncidents.length > 0 ? Math.round((weekResolved / weekIncidents.length) * 100) : 0;
            
            document.getElementById('weeklyProgress').style.width = `${weekProgress}%`;
            document.getElementById('weeklyProgress').textContent = `${weekProgress}%`;
            document.getElementById('resolvedThisWeek').textContent = weekResolved;
            document.getElementById('totalThisWeek').textContent = weekIncidents.length;
            
            // Cargar incidencias recientes
            loadRecentIncidents();
            
            // Actualizar gr√°ficos
            updateCharts();
        }

        // Funci√≥n para cargar incidencias recientes
        function loadRecentIncidents() {
            const container = document.getElementById('recentIncidents');
            const recent = incidents.slice(-5).reverse();
            
            if (recent.length === 0) {
                container.innerHTML = '<p style="color: var(--gray); text-align: center;">No hay incidencias registradas</p>';
                return;
            }
            
            container.innerHTML = recent.map(incident => createIncidentCard(incident)).join('');
        }

        // Funci√≥n para crear tarjeta de incidencia
        function createIncidentCard(incident) {
            const priorityClass = incident.priority;
            const statusClass = incident.status;
            
            return `
                <div class="incident-card ${priorityClass}">
                    <div class="incident-header">
                        <div>
                            <span class="incident-id">${incident.id}</span>
                            <h4 class="incident-title">${incident.title}</h4>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <span class="priority-badge priority-${incident.priority}">
                                ${getPriorityLabel(incident.priority)}
                            </span>
                            <span class="status-badge status-${incident.status}">
                                ${getStatusLabel(incident.status)}
                            </span>
                        </div>
                    </div>
                    <p style="color: var(--gray); margin-bottom: 10px;">${incident.description}</p>
                    <div class="incident-meta">
                        <span class="meta-item">üìÅ ${incident.project}</span>
                        <span class="meta-item">üë§ ${incident.reporter}</span>
                        <span class="meta-item">üìÖ ${formatDate(incident.createdAt)}</span>
                        <span class="meta-item">üè∑Ô∏è ${incident.category}</span>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="updateIncidentStatus('${incident.id}', 'progress')" 
                            ${incident.status !== 'new' ? 'disabled' : ''}>
                            ‚ñ∂Ô∏è Iniciar
                        </button>
                        <button class="btn btn-success" onclick="updateIncidentStatus('${incident.id}', 'resolved')"
                            ${incident.status === 'resolved' || incident.status === 'closed' ? 'disabled' : ''}>
                            ‚úÖ Resolver
                        </button>
                        <button class="btn btn-warning" onclick="viewIncidentDetails('${incident.id}')">
                            üëÅÔ∏è Detalles
                        </button>
                    </div>
                </div>
            `;
        }

        // Funci√≥n para actualizar estado de incidencia
        function updateIncidentStatus(incidentId, newStatus) {
            const incident = incidents.find(i => i.id === incidentId);
            if (!incident) return;
            
            incident.status = newStatus;
            incident.updatedAt = new Date().toISOString();
            incident.history.push({
                date: new Date().toISOString(),
                action: `Estado cambiado a: ${getStatusLabel(newStatus)}`,
                user: 'Sistema'
            });
            
            saveData();
            updateDashboard();
            loadIncidentsList();
        }

        // Funci√≥n para ver detalles de incidencia
        function viewIncidentDetails(incidentId) {
            const incident = incidents.find(i => i.id === incidentId);
            if (!incident) return;
            
            const timeline = incident.history.map(h => `
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <div class="timeline-date">${formatDate(h.date)}</div>
                        <div class="timeline-text">${h.action} - ${h.user}</div>
                    </div>
                </div>
            `).join('');
            
            const details = `
                <div style="padding: 20px;">
                    <h3>${incident.title}</h3>
                    <p><strong>ID:</strong> ${incident.id}</p>
                    <p><strong>Proyecto:</strong> ${incident.project}</p>
                    <p><strong>Descripci√≥n:</strong> ${incident.description}</p>
                    <p><strong>Prioridad:</strong> ${getPriorityLabel(incident.priority)}</p>
                    <p><strong>Estado:</strong> ${getStatusLabel(incident.status)}</p>
                    <p><strong>Reportado por:</strong> ${incident.reporter}</p>
                    <p><strong>Email:</strong> ${incident.email || 'No proporcionado'}</p>
                    <p><strong>Pasos para reproducir:</strong></p>
                    <pre style="background: #f3f4f6; padding: 10px; border-radius: 5px;">${incident.steps || 'No especificados'}</pre>
                    
                    <h4 style="margin-top: 20px;">Historial de Cambios</h4>
                    <div class="timeline">${timeline}</div>
                </div>
            `;
            
            // Crear modal simple
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; max-width: 800px; max-height: 80vh; overflow-y: auto; margin: 20px;">
                    ${details}
                    <div style="padding: 20px; text-align: center;">
                        <button class="btn btn-primary" onclick="this.closest('div[style*=position]').remove()">Cerrar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Funci√≥n para cargar lista de incidencias
        function loadIncidentsList() {
            const container = document.getElementById('incidentsList');
            const filtered = filterIncidents();
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="color: var(--gray); text-align: center;">No hay incidencias que coincidan con los filtros</p>';
                return;
            }
            
            container.innerHTML = filtered.map(incident => createIncidentCard(incident)).join('');
            
            // Actualizar filtro de proyectos
            updateProjectFilter();
        }

        // Funci√≥n para filtrar incidencias
        function filterIncidents() {
            const statusFilter = document.getElementById('filterStatus').value;
            const priorityFilter = document.getElementById('filterPriority').value;
            const projectFilter = document.getElementById('filterProject').value;
            
            let filtered = [...incidents];
            
            if (statusFilter) {
                filtered = filtered.filter(i => i.status === statusFilter);
            }
            
            if (priorityFilter) {
                filtered = filtered.filter(i => i.priority === priorityFilter);
            }
            
            if (projectFilter) {
                filtered = filtered.filter(i => i.project === projectFilter);
            }
            
            return filtered.reverse();
        }

        // Funci√≥n para actualizar filtro de proyectos
        function updateProjectFilter() {
            const projects = [...new Set(incidents.map(i => i.project))];
            const select = document.getElementById('filterProject');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">Todos</option>' + 
                projects.map(p => `<option value="${p}">${p}</option>`).join('');
            
            select.value = currentValue;
        }

        // Funci√≥n para generar reporte
        function generateReport() {
            const startDate = new Date(document.getElementById('reportStartDate').value || new Date().setDate(new Date().getDate() - 7));
            const endDate = new Date(document.getElementById('reportEndDate').value || new Date());
            
            const periodIncidents = incidents.filter(i => {
                const date = new Date(i.createdAt);
                return date >= startDate && date <= endDate;
            });
            
            // Generar resumen
            const summary = {
                total: periodIncidents.length,
                new: periodIncidents.filter(i => i.status === 'new').length,
                progress: periodIncidents.filter(i => i.status === 'progress').length,
                resolved: periodIncidents.filter(i => i.status === 'resolved').length,
                closed: periodIncidents.filter(i => i.status === 'closed').length,
                critical: periodIncidents.filter(i => i.priority === 'critical').length,
                high: periodIncidents.filter(i => i.priority === 'high').length,
                medium: periodIncidents.filter(i => i.priority === 'medium').length,
                low: periodIncidents.filter(i => i.priority === 'low').length
            };
            
            // Mostrar resumen
            document.getElementById('reportSummary').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div><strong>Total de Incidencias:</strong> ${summary.total}</div>
                    <div><strong>Nuevas:</strong> ${summary.new}</div>
                    <div><strong>En Progreso:</strong> ${summary.progress}</div>
                    <div><strong>Resueltas:</strong> ${summary.resolved}</div>
                    <div><strong>Cerradas:</strong> ${summary.closed}</div>
                </div>
                <hr style="margin: 15px 0;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div><strong>Cr√≠ticas:</strong> ${summary.critical}</div>
                    <div><strong>Altas:</strong> ${summary.high}</div>
                    <div><strong>Medias:</strong> ${summary.medium}</div>
                    <div><strong>Bajas:</strong> ${summary.low}</div>
                </div>
            `;
            
            // Calcular m√©tricas
            const resolvedIncidents = periodIncidents.filter(i => i.status === 'resolved' || i.status === 'closed');
            const avgResolutionTime = resolvedIncidents.length > 0 
                ? resolvedIncidents.reduce((acc, i) => {
                    const created = new Date(i.createdAt);
                    const updated = new Date(i.updatedAt);
                    return acc + (updated - created) / (1000 * 60 * 60 * 24);
                }, 0) / resolvedIncidents.length
                : 0;
            
            document.getElementById('reportMetrics').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <strong>Tasa de Resoluci√≥n:</strong> 
                        ${summary.total > 0 ? Math.round((resolvedIncidents.length / summary.total) * 100) : 0}%
                    </div>
                    <div>
                        <strong>Tiempo Promedio de Resoluci√≥n:</strong> 
                        ${avgResolutionTime.toFixed(1)} d√≠as
                    </div>
                    <div>
                        <strong>Incidencias Pendientes:</strong> 
                        ${summary.new + summary.progress}
                    </div>
                </div>
            `;
            
            // Mostrar detalle
            document.getElementById('reportDetails').innerHTML = periodIncidents.length > 0
                ? `<table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--light);">
                            <th style="padding: 10px; text-align: left;">ID</th>
                            <th style="padding: 10px; text-align: left;">T√≠tulo</th>
                            <th style="padding: 10px; text-align: left;">Proyecto</th>
                            <th style="padding: 10px; text-align: left;">Prioridad</th>
                            <th style="padding: 10px; text-align: left;">Estado</th>
                            <th style="padding: 10px; text-align: left;">Fecha</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${periodIncidents.map(i => `
                            <tr style="border-bottom: 1px solid var(--light);">
                                <td style="padding: 10px;">${i.id}</td>
                                <td style="padding: 10px;">${i.title}</td>
                                <td style="padding: 10px;">${i.project}</td>
                                <td style="padding: 10px;">
                                    <span class="priority-badge priority-${i.priority}">
                                        ${getPriorityLabel(i.priority)}
                                    </span>
                                </td>
                                <td style="padding: 10px;">
                                    <span class="status-badge status-${i.status}">
                                        ${getStatusLabel(i.status)}
                                    </span>
                                </td>
                                <td style="padding: 10px;">${formatDate(i.createdAt)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`
                : '<p style="color: var(--gray); text-align: center;">No hay incidencias en el per√≠odo seleccionado</p>';
            
            document.getElementById('reportContent').style.display = 'block';
        }

        // Funci√≥n para exportar reporte a CSV
        function exportReport() {
            const startDate = new Date(document.getElementById('reportStartDate').value || new Date().setDate(new Date().getDate() - 7));
            const endDate = new Date(document.getElementById('reportEndDate').value || new Date());
            
            const periodIncidents = incidents.filter(i => {
                const date = new Date(i.createdAt);
                return date >= startDate && date <= endDate;
            });
            
            // Crear CSV
            let csv = 'ID,T√≠tulo,Proyecto,Descripci√≥n,Prioridad,Estado,Categor√≠a,Reportado por,Email,Fecha Creaci√≥n,√öltima Actualizaci√≥n\n';
            
            periodIncidents.forEach(i => {
                csv += `"${i.id}","${i.title}","${i.project}","${i.description}","${getPriorityLabel(i.priority)}","${getStatusLabel(i.status)}","${i.category}","${i.reporter}","${i.email || ''}","${formatDate(i.createdAt)}","${formatDate(i.updatedAt)}"\n`;
            });
            
            // Descargar archivo
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `reporte_incidencias_${formatDate(new Date(), 'file')}.csv`;
            link.click();
        }

        // Funci√≥n para actualizar gr√°ficos
        function updateCharts() {
            // Gr√°fico de estado
            drawPieChart('statusChart', {
                'Nuevo': incidents.filter(i => i.status === 'new').length,
                'En Progreso': incidents.filter(i => i.status === 'progress').length,
                'Resuelto': incidents.filter(i => i.status === 'resolved').length,
                'Cerrado': incidents.filter(i => i.status === 'closed').length
            }, ['#3b82f6', '#f59e0b', '#10b981', '#6b7280']);
            
            // Gr√°fico de prioridades
            drawPieChart('priorityChart', {
                'Cr√≠tica': incidents.filter(i => i.priority === 'critical').length,
                'Alta': incidents.filter(i => i.priority === 'high').length,
                'Media': incidents.filter(i => i.priority === 'medium').length,
                'Baja': incidents.filter(i => i.priority === 'low').length
            }, ['#ef4444', '#f59e0b', '#3b82f6', '#10b981']);
            
            // Gr√°fico de tendencia
            drawTrendChart();
        }

        // Funci√≥n para dibujar gr√°fico de pastel
        function drawPieChart(canvasId, data, colors) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const total = Object.values(data).reduce((a, b) => a + b, 0);
            
            if (total === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#6b7280';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Sin datos', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            let currentAngle = -Math.PI / 2;
            const centerX = 100;
            const centerY = 100;
            const radius = 70;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            Object.entries(data).forEach(([label, value], index) => {
                const sliceAngle = (value / total) * 2 * Math.PI;
                
                // Dibujar sector
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.lineTo(centerX, centerY);
                ctx.fillStyle = colors[index];
                ctx.fill();
                
                // Dibujar etiqueta
                const labelX = centerX + Math.cos(currentAngle + sliceAngle / 2) * (radius + 20);
                const labelY = centerY + Math.sin(currentAngle + sliceAngle / 2) * (radius + 20);
                
                ctx.fillStyle = '#374151';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${label}: ${value}`, labelX + 100, labelY);
                
                currentAngle += sliceAngle;
            });
        }

        // Funci√≥n para dibujar gr√°fico de tendencia
        function drawTrendChart() {
            const canvas = document.getElementById('trendChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Obtener datos de los √∫ltimos 7 d√≠as
            const days = [];
            const counts = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                date.setHours(0, 0, 0, 0);
                
                const nextDate = new Date(date);
                nextDate.setDate(nextDate.getDate() + 1);
                
                const dayIncidents = incidents.filter(inc => {
                    const incDate = new Date(inc.createdAt);
                    return incDate >= date && incDate < nextDate;
                });
                
                days.push(date.toLocaleDateString('es', { weekday: 'short' }));
                counts.push(dayIncidents.length);
            }
            
            const maxCount = Math.max(...counts, 1);
            const chartWidth = 350;
            const chartHeight = 150;
            const barWidth = chartWidth / 7;
            
            // Dibujar barras
            counts.forEach((count, index) => {
                const barHeight = (count / maxCount) * chartHeight;
                const x = index * barWidth + 25;
                const y = chartHeight - barHeight + 20;
                
                ctx.fillStyle = '#3b82f6';
                ctx.fillRect(x, y, barWidth - 10, barHeight);
                
                // Valor encima de la barra
                ctx.fillStyle = '#374151';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(count, x + (barWidth - 10) / 2, y - 5);
                
                // D√≠a debajo
                ctx.fillText(days[index], x + (barWidth - 10) / 2, chartHeight + 35);
            });
        }

        // Funciones auxiliares
        function getPriorityLabel(priority) {
            const labels = {
                'critical': 'Cr√≠tica',
                'high': 'Alta',
                'medium': 'Media',
                'low': 'Baja'
            };
            return labels[priority] || priority;
        }

        function getStatusLabel(status) {
            const labels = {
                'new': 'Nuevo',
                'progress': 'En Progreso',
                'resolved': 'Resuelto',
                'closed': 'Cerrado'
            };
            return labels[status] || status;
        }

        function formatDate(dateString, format = 'display') {
            const date = new Date(dateString);
            if (format === 'file') {
                return date.toISOString().split('T')[0];
            }
            return date.toLocaleDateString('es', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Inicializar al cargar
        document.addEventListener('DOMContentLoaded', function() {
            // Establecer fechas por defecto en el reporte
            const today = new Date();
            const weekAgo = new Date();
            weekAgo.setDate(today.getDate() - 7);
            
            document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
            document.getElementById('reportStartDate').value = weekAgo.toISOString().split('T')[0];
            
            // Cargar dashboard inicial
            updateDashboard();
            
            // Agregar algunos datos de ejemplo si no hay incidencias
            if (incidents.length === 0) {
                incidents = [
                    {
                        id: 'INC-1001',
                        title: 'Error de conexi√≥n a base de datos',
                        project: 'Sistema Principal',
                        description: 'El sistema no puede conectarse a la base de datos principal',
                        priority: 'critical',
                        category: 'data',
                        reporter: 'Juan P√©rez',
                        email: 'juan@ejemplo.com',
                        status: 'new',
                        createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                        updatedAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                        history: [{
                            date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                            action: 'Incidencia creada',
                            user: 'Juan P√©rez'
                        }]
                    },
                    {
                        id: 'INC-1002',
                        title: 'Bot√≥n de guardar no funciona',
                        project: 'M√≥dulo de Ventas',
                        description: 'El bot√≥n de guardar en el formulario de ventas no responde',
                        priority: 'high',
                        category: 'ui',
                        reporter: 'Mar√≠a Garc√≠a',
                        email: 'maria@ejemplo.com',
                        status: 'progress',
                        createdAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                        updatedAt: new Date().toISOString(),
                        history: [
                            {
                                date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                                action: 'Incidencia creada',
                                user: 'Mar√≠a Garc√≠a'
                            },
                            {
                                date: new Date().toISOString(),
                                action: 'Estado cambiado a: En Progreso',
                                user: 'Sistema'
                            }
                        ]
                    },
                    {
                        id: 'INC-1003',
                        title: 'Lentitud en carga de reportes',
                        project: 'M√≥dulo de Reportes',
                        description: 'Los reportes tardan m√°s de 30 segundos en cargar',
                        priority: 'medium',
                        category: 'performance',
                        reporter: 'Carlos L√≥pez',
                        email: 'carlos@ejemplo.com',
                        status: 'resolved',
                        createdAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                        updatedAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                        history: [
                            {
                                date: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                                action: 'Incidencia creada',
                                user: 'Carlos L√≥pez'
                            },
                            {
                                date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                                action: 'Estado cambiado a: Resuelto',
                                user: 'Sistema'
                            }
                        ]
                    }
                ];
                currentIncidentId = 1003;
                saveData();
                updateDashboard();
            }
        });
    </script>
</body>
</html>